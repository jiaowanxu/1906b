2020-6-19
-------------------------------------------------分散事务-------------------------------------------------------
			-事务的介绍
			-RabbitMQ可靠消息最终一致性介绍
			-RabbitMQ可靠消息最终一致性实现
			
		一，事务
			1，介绍：
				通俗一点说，如果这几条SQL语句全部执行成功，则才对数据库进行一次更新，如果有一条SQL语句执行失败，
				则这几条SQL语句全部不进行执行，这个时候需要用到事务。
				
			2，数据库事务的四大特性ACID：	
				原子性（原子性）
					原子性是指事务是一个不可分割的工作单位，事务中的操作要么都执行，要么都不执行。
				一致性（Consistency）
					 事务前后的数据都是正确的。
				隔离性（Isolation）
					事务隔离可以避免脏读等问题。
				持久性（耐久性）
					永久性是指一个事务一旦被提交，该事务对数据的更改会被永久化到数据库，且不会被回滚。 	
			3，本地事务
				概念：
					基于关系型数据库的事务又被称为本地事务。
			4，三种对事务操作：
				a，数据库本身控制事物：
					开始交易
						  // 1。本地数据库操作：张三减少金额
						  // 2。本地数据库操作：李四增加金额
					回滚
					或
					进行翻译；
					
				b，jdbc中使用物体：
					1.获取对数据库的连接
					2.设置事务不自动提交（有时是自动提交的）
					3.把想要一次性提交的几个sql语句用事务进行提交
					4.捕获异常，进行数据的回滚（回滚一般写在catch块中）
					
				c，aop控制事务：
					1.配置事务管理器
					2.配置事务的通知
					3.配置切面
					
			5，分布式事务
				a，概述：
					随着互联网的快速发展，软件系统由原来的单体应用转变为分布式应用
					这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务并进行分布式事务
					
				b，分布式物体产生的场景	
					多个服务操作多个数据库
										
					多个服务操作一个数据库
						例如：订单微服务和库存微服务，下单的同时订单微服务请求库存微服务减库存。简言之：跨JVM进程产生分布式事务。
		
		二，RabbitMQ可靠消息最终一致性介绍
			智商
				RocketMQ，RabbitMQ，Kafka，ActiveMQ 
			1，为什么要使用可靠消息最终一致性
				在开发过程中，可能服务间的调用是异步的，则针对这种基于MQ的异步调用。从而，希望的是基于MQ实现异步调用的多个服务的业务逻辑，
				一起成功，或者一起失败。这个时候，就要用上可靠消息最终一致性方案，来实现分布式事务。
				
			2，什么是可靠消息最终一致性
				可靠消息最终一致性方案是指当：
					事务发起方执行完成本地事务后并发出一条消息，
					事务参与方（消息消费者）一定能够接收消息并处理事务成功
					
			3.可靠消息最终一致性要解决的问题：
				a。上游服务把信息成功发送
				
				b。下游服务要把消息成功消费
				
				c。对消息做幂
				
			4.解决方案	
				问题一：上游服务把消息成功发送
					本地消息表方案，该方案最初是eBay提出
					 消息记录表（orderId状态）+ quatz（定时扫描，发送消息）
				
				b。问题二：下游服务成把消息成功消费
					持久化+手动确认方案
						持久化（mq停机消息不丢失），手动确认（任务处理失败消息还在容器中）
				
				c。问题三：对消息做幂等
					记录消息的消费
					
		三，RabbitMQ实现可靠消息最终一致性
			usian_order_service：

			   1，保存订单信息

			   2，保存本地消息记录

			   3，向MQ服务器发送转账消息

			   4，在MQ Server响应返回后更新本地消息为已成功发送状态

			usian_item_service：

				   1，接收消息，扣减库存

				   2，向MQ Server发送应答状态

				   3，对扣减库存方法做幂等